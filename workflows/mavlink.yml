name: Build PX4

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'mavlink/bell.xml'
      - 'mavlink/generate.sh'

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'ci skip')"

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Configure git
      run: |
        git config --global user.email "github-bot@bellflight.com"
        git config --global user.name "Github Actions"
        git config --global credential.helper "store --file=$HOME/.git-credentials"
        echo "https://${GH_TOKEN}:@github.com" > "$HOME"/.git-credentials

    - name: Generate custom PX4 firmware
      run: mavlink/generate.sh

    - name: Commit changes to FCC
      run: |
        git add vmc/flight_control_module/mavlink || exit 0
        git commit -m "Autogenerated code at $(date)" || exit 0 
        git push origin main

    - name: Bump version and push tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v5.6
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_version.outputs.new_tag }}
        fail_on_unmatched_files: true
        files: |
          mavlink/target/*.px4